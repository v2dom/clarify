<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clarify - Spotify Insights</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white">
  <div class="flex flex-col items-center justify-center h-screen text-center px-4">
    <h1 class="text-4xl font-bold text-green-500 mt-8" id="greeting">Welcome to Clarify</h1>
    <p class="text-xl mt-2" id="status">Loading Spotify data...</p>
    <div id="user-info" class="text-center mt-4"></div>
  </div>
  <script>
    const BACKEND_URL = "https://clarify-3zv7.onrender.com";

    async function refreshToken(refreshToken) {
      try {
        const res = await fetch(`${BACKEND_URL}/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh_token: refreshToken })
        });

        if (!res.ok) throw new Error("Refresh failed");

        const data = await res.json();
        localStorage.setItem("spotify_access_token", data.access_token);
        localStorage.setItem("spotify_token_expiry", Date.now() + data.expires_in * 1000);
        return data.access_token;
      } catch (err) {
        console.error("Refresh error:", err);
        return null;
      }
    }

    async function ensureAccessToken() {
      const urlParams = new URLSearchParams(window.location.search);
      let accessToken = urlParams.get("access_token");
      const refreshTokenParam = urlParams.get("refresh_token");
      const expiresIn = urlParams.get("expires_in");

      if (accessToken && refreshTokenParam && expiresIn) {
        localStorage.setItem("spotify_access_token", accessToken);
        localStorage.setItem("spotify_refresh_token", refreshTokenParam);
        localStorage.setItem("spotify_token_expiry", Date.now() + parseInt(expiresIn) * 1000);
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      const token = localStorage.getItem("spotify_access_token");
      const expiry = localStorage.getItem("spotify_token_expiry");
      const refresh = localStorage.getItem("spotify_refresh_token");

      if (!token) return null;
      if (expiry && Date.now() > expiry) {
        return await refreshToken(refresh);
      }
      return token;
    }

    async function fetchSpotifyProfile(token) {
      try {
        const res = await fetch("https://api.spotify.com/v1/me", {
          headers: { Authorization: `Bearer ${token}` }
        });
        return await res.json();
      } catch (err) {
        console.error("Spotify profile error:", err);
        return null;
      }
    }

    window.onload = async () => {
      const token = await ensureAccessToken();
      if (!token) {
        document.getElementById("status").textContent = "Login failed or expired. Please try again.";
        return;
      }
      const profile = await fetchSpotifyProfile(token);
      if (profile && profile.display_name) {
        document.getElementById("greeting").textContent = `Hi, ${profile.display_name}`;
        document.getElementById("status").textContent = "";
      } else {
        document.getElementById("status").textContent = "Failed to load Spotify data.";
      }
    };
  </script>
</body>
</html>
